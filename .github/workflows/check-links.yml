name: 检查失效链接

on:
  # 每周日凌晨2点自动运行
  schedule:
    - cron: '0 2 * * 0'
  # 手动触发
  workflow_dispatch:
  # 发布时检查
  push:
    branches: [master]
    paths:
      - '_posts/**'
      - '_pages/**'

permissions:
  contents: read
  issues: write

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: 构建网站
        run: bundle exec jekyll build

      - name: 检查链接
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress --format markdown --output lychee-report.md './_site/**/*.html'
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 上传链接检查报告
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: link-check-report
          path: lychee-report.md

      - name: 创建或更新问题报告
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = '发现失效链接';
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;

            // 查找是否已有同标题的开启状态 Issue
            const { data: openIssues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              per_page: 100
            });

            const existing = openIssues.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existing.number,
                body: `⚠️ 自动链接检查再次发现失效链接。\n\n- 运行记录: ${runUrl}\n- 报告已作为构件(artifact)上传: link-check-report/lychee-report.md\n\n请查看最新报告以修复链接。`
              });
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body: `自动检查发现了一些失效的链接。\n\n- 运行记录: ${runUrl}\n- 报告已作为构件(artifact)上传: link-check-report/lychee-report.md\n\n请查看 Actions 日志与报告了解详情。`,
                labels: ['bug', '自动检测']
              });
            }

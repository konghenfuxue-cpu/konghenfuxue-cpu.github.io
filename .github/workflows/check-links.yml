name: 检查失效链接

on:
  # 每周日凌晨2点自动运行
  schedule:
    - cron: '0 2 * * 0'
  # 手动触发
  workflow_dispatch:
  # 发布时检查
  push:
    branches: [master]
    paths:
      - '_posts/**'
      - '_pages/**'

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: 构建网站
        run: bundle exec jekyll build

      - name: 检查链接
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress './_site/**/*.html'
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 创建问题报告
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '发现失效链接',
              body: '自动检查发现了一些失效的链接,请查看 Actions 日志了解详情。',
              labels: ['bug', '自动检测']
            })
